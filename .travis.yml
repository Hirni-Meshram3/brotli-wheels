env:
  global:
    # directory containing the project source
    - REPO_DIR=brotli
    # Commit from your-project that you want to build
    - BUILD_COMMIT=v1.0.4
    # pip dependencies to _build_ project
    - BUILD_DEPENDS=
    # pip dependencies to _test_ project
    - TEST_DEPENDS=
    - PLAT=x86_64
    - UNICODE_WIDTH=32

language: python
# The travis Python version is unrelated to the version we build and test
# with.  This is set with the MB_PYTHON_VERSION variable.
python: 3.6
sudo: required
dist: trusty
services: docker

matrix:
  exclude:
    # Exclude the default Python 3.6 build
    - python: 3.6
  include:
    - os: linux
      env: MB_PYTHON_VERSION=2.7
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - UNICODE_WIDTH=16
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - PLAT=i686
        - UNICODE_WIDTH=16
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.4
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.4
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.5
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.5
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.6
        - BUILD_SDIST=true
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.6
        - PLAT=i686
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=2.7
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=3.4
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=3.5
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=3.6

before_install:
  - source multibuild/common_utils.sh
  - source multibuild/travis_steps.sh
  - before_install

install:
  - clean_code $REPO_DIR $BUILD_COMMIT
  - build_wheel $REPO_DIR $PLAT

script:
  - install_run $PLAT

after_success:
  # if tagged, create the source distribution for the deploy stage,
  # and copy compiled wheel to dist/ where Travis `dpl` expects it
  - >
    if [ -n "$TRAVIS_TAG" ]; then
      distdir=${TRAVIS_BUILD_DIR}/dist;
      mkdir -p $distdir;
      if [ "$BUILD_SDIST" == true ]; then
        pip install -U setuptools;
        (cd $REPO_DIR && python setup.py sdist --dist-dir $distdir --formats=zip);
      fi;
      cp ${TRAVIS_BUILD_DIR}/wheelhouse/*.whl $distdir
    fi

deploy:
  # deploy on tags to Github Releases
  - provider: releases
    api_key:
      secure: nD+188iPAfLilKYtGhIdvDJzOq0j9omBzVcHsXQSxK6+OkUmvi1up8tww7gkA3ilym4BPgdT9Ovsh1VcpKj33IeU8Oh3UKrl/TJFL4geaUh9+bQv9Vucv8FPY+S5gV4mJaVJvFU8ulriYtmLjFRBNJmuM8xcu9VNGThI86iWJotRlYhMGXbrmDOWnOLixQ/61mlgilfeXTu3OE1B2luMXnCLpP1Lz7GhFBfsBu2LgpZBETZZ8rTcqDaSRxUKY17WAN36pQOHhWTxOwqfzFlBW4IUUgOC7Rpkrx7jMiVbKvtDyxw6UHJE0q0hVQsd8Wa1LacOfQiiZF5p2ES9sNfo+Y5TzhdIZ303udXiFyEruzTONC+TFeIEuaWE5+jDC7vwEmpdZ8+elb1I+cOoOtSmepObyrLw+fAlxKyibTN0HD6BdCrqTUQySRjJbjvSzJfdhE1cuBbV0napQWSx5ZfSyg3zIPwynKn+y9ujUt0szc4Ke/mEdrvLBn+bbgsmrXWfo91eyJFsVBiOcLpcH5pT2zHJg7XcWgMffN0NuDwVh0+JFbF8gJG2WKjnlHrpskW4gP9c/iq8d5NVtJW1XOEowK10IOYpgkwP7FP5rwybpMe3wBbBw6c96mmAtON0vogSe1i2LJjZh8F91DNMe7I2kikBLQahzsEAQyOi+20xJZw=
    file_glob: true
    file: "dist/*"
    skip_cleanup: true
    on:
      repo: google/brotli-wheels
      tags: true
